////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Project name     : eCapture
// Client           : Energy Australia, via AEC Systems, Sydney
//
// File name        : VRLayer0Dlg.cpp
// Created          : 24th January 2008
// Created by       : S. Jaisimha
// Description      : Implementation for the "Layer 0" tab of the validation results dialog
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "StdAfx.h"
#include "Resource.h"
#include "VRLayer0Dlg.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Zoom helper from ValidateResultsDlg.cpp
extern void ZoomToSelection(CListCtrl& lcList, int iHandleCol, int iLayerCol);
extern void AcceptError(CListCtrl& lcList, int iRow, int iHandleCol, CString csErrorType);


// CVRLayer0Dlg dialog
IMPLEMENT_DYNAMIC(CVRLayer0Dlg, CDialog)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::CVRLayer0Dlg
// Description  : Default constructor
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CVRLayer0Dlg::CVRLayer0Dlg(CWnd* pParent /*=NULL*/)	: CDialog(CVRLayer0Dlg::IDD, pParent)
{

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::~CVRLayer0Dlg
// Description  : Default destructor
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CVRLayer0Dlg::~CVRLayer0Dlg()
{
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::DoDataExchange
// Description  : Dialog to variable data transfer
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CVRLayer0Dlg::DoDataExchange(CDataExchange* pDX)
{
  CDialog::DoDataExchange(pDX);
  DDX_Control(pDX, IDC_LAYER0_LIST, m_lcLayer0);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : BEGIN_MESSAGE_MAP
// Description  : Message handlers
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN_MESSAGE_MAP(CVRLayer0Dlg, CDialog)
  ON_NOTIFY(NM_CLICK, IDC_LAYER0_LIST, &CVRLayer0Dlg::OnZoomToObject)
  ON_BN_CLICKED(IDC_ERROR_ACCEPT,      &CVRLayer0Dlg::OnBnClickedErrorAccept)
END_MESSAGE_MAP()

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::OnInitDialog
// Description  : Called before the dialog is displayed on screen
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
BOOL CVRLayer0Dlg::OnInitDialog()
{
  // Call the parent implementation
  CDialog::OnInitDialog();

  // Initialize the list control
  m_lcLayer0.InsertColumn(0, _T("Error"),       LVCFMT_LEFT,   80);
  m_lcLayer0.InsertColumn(1, _T("Object type"), LVCFMT_LEFT,  200);
  m_lcLayer0.InsertColumn(2, _T("Handle"),      LVCFMT_LEFT,    0);
  m_lcLayer0.InsertColumn(3, _T("Layer"),       LVCFMT_LEFT,    0);
  m_lcLayer0.InsertColumn(4, _T("EHdl"),        LVCFMT_LEFT,    0);
  m_lcLayer0.SetExtendedStyle(LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);

  // Add the values from the arrays
  for (int iCtr = 0; iCtr < m_csa0Names.GetSize(); iCtr++)
  {
    m_lcLayer0.InsertItem(iCtr, m_csaErrorNos.GetAt(iCtr));
    m_lcLayer0.SetItemText(iCtr, 1, m_csa0Names.GetAt(iCtr));
    m_lcLayer0.SetItemText(iCtr, 2, m_csa0Handles.GetAt(iCtr));
    m_lcLayer0.SetItemText(iCtr, 3, _T("0"));
    m_lcLayer0.SetItemText(iCtr, 4, m_csaErrHandles.GetAt(iCtr));
  }

  // Everything is OK
  return TRUE;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::OnZoomToObject
// Description  : Called when the user clicks on an entry in the list
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CVRLayer0Dlg::OnZoomToObject(NMHDR *pNMHDR, LRESULT *pResult)
{
  // Call the zoom function
  ZoomToSelection(m_lcLayer0, 2, 3);

  // Nullify the result
  *pResult = 0;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::OnBnClickedErrorAccept
// Description  : Called when the user clicks on the "Accept" button
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CVRLayer0Dlg::OnBnClickedErrorAccept()
{
  // Get the selected item
  int iIndex = m_lcLayer0.GetSelectionMark();
  if (iIndex == LB_ERR) return;

  // Call the AcceptError method
  AcceptError(m_lcLayer0, iIndex, 2, _T("ON LAYER 0"));
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function     : CVRLayer0Dlg::WriteToReport
// Description  : Called to write to the already open report file
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CVRLayer0Dlg::WriteToReport(CStdioFile &cfLog)
{
  // If there is no data in the array, return now
  if (m_csa0Names.GetSize() == 0) return;

  // Write the tab header
  CString csLine, csTemp; 
  csLine.Format(_T("\n-----------------------------------------\nGeometry on layer 0: %d\n-----------------------------------------\n"), m_lcLayer0.GetItemCount()); 
  cfLog.WriteString(csLine);

  // Write the details
  for (int iCtr = 0; iCtr < m_lcLayer0.GetItemCount(); iCtr++)
  {
    csLine.Format(_T("%d. [E%s] %s\n"), iCtr + 1, m_lcLayer0.GetItemText(iCtr, 0), m_lcLayer0.GetItemText(iCtr, 1));
    cfLog.WriteString(csLine);
  }
}
